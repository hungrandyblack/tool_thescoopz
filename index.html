<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Kiểm tra Scoopz Channel</title>
  <script src="tailwindcss.js"></script>
</head>
<style>
  /* HTML: <div class="loader"></div> */
.loader {
  width: 60px;
  aspect-ratio: 4;
  background: radial-gradient(circle closest-side,#000 90%,#0000) 0/calc(100%/3) 100% space;
  clip-path: inset(0 100% 0 0);
  animation: l1 1s steps(4) infinite;
}
@keyframes l1 {to{clip-path: inset(0 -34% 0 0)}}
</style>
<body class="bg-gray-100 text-gray-800 min-h-screen">
  <div class="mx-auto p-6 max-w-6xl">
    <h1 class="text-3xl font-bold mb-6 text-center">Kiểm tra thông tin kênh Scoopz</h1>

    <!-- Form kiểm tra -->
    <form id="form-check" class="bg-white p-6 rounded-lg shadow-md flex flex-col sm:flex-row gap-4 items-center mb-6">
      <input type="text" id="channel_url" name="channel_url" placeholder="https://thescoopz.com/@..." required
        class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
      <button type="button" id="btn-check"
        class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition">Kiểm tra</button>
    </form>

    <!-- Kết quả -->
    <div id="result" class="bg-white p-4 rounded-lg shadow-md mb-6 min-h-[80px]"></div>
    <div class="mb-3">
      <a href="?sort=desc" data-sort="desc" class="px-3 py-2 bg-blue-700 text-white rounded">
        View cao nhất
      </a>

      <a href="?sort=asc" data-sort="asc" class="px-3 py-2 bg-gray-500 text-white rounded ml-2">
        View thấp nhất
      </a>

     <button id="kiem-tra-tong" class="px-3 py-2 bg-gray-500 text-white rounded ml-2">
    Kiểm tra tổng
</button>
    </div>
    <!-- Search -->
    <div class="flex gap-2 mb-4">
      <input type="text" id="search_keyword" placeholder="Tìm theo URL hoặc tên kênh"
        class="flex-1 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
      <button id="btn-search" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">Search</button>
    </div>

    <!-- Lịch sử -->
    <div id="history" class="bg-white p-4 rounded-lg shadow-md overflow-x-auto"></div>
    <div id="pagination" class="mt-3 flex justify-center gap-2"></div>
  </div>
  <!-- Modal -->
<div id="queueModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-96">
        <h2 class="text-xl font-bold mb-4">Trạng thái xử lý</h2>
        <div class="loader"></div>
        <div class="mb-2">Đang chạy: <span id="runningCount">0</span></div>
        <div class="mb-2">Thành công: <span id="successCount">0</span></div>
        <div class="mb-2">Thất bại: <span id="errorCount">0</span></div>

        <button id="closeModal" class="mt-4 px-4 py-2 bg-red-500 text-white rounded">
            Đóng
        </button>
    </div>
</div>
  <script src="jquery.min.js"></script>
  <script>
let polling = null;
let batchID = null;
$('#kiem-tra-tong').on('click', function () {

    $('#queueModal').removeClass('hidden');

    $.ajax({
        url: 'kiem_tra_tong.php',
        type: 'GET',
        dataType: 'json',
        success: function(res) {
            
            // Nếu file trả JSON gồm {dang_chay: xx}
            if (res.total !== undefined) {
                $('#runningCount').text(res.total);
            }
            batchID = res.batch_id;   // lưu batch cho lần này
            console.log("Batch ID:", batchID);

            console.log("Queue started:", res);

            // bắt đầu polling 5s
            polling = setInterval(checkQueueStatus, 5000);
        }
    });
});


function checkQueueStatus() {
    $.ajax({
        url: 'queue_status.php',
        type: 'GET',
        data: { batch_id: batchID },
        dataType: 'json',
        success: function(data) {

            $('#runningCount').text(data.running);
            $('#successCount').text(data.success);
            $('#errorCount').text(data.error);

            // ⛔ Nếu hết job đang chạy → dừng polling
            if (data.running === 0) {
              clearInterval(polling);
              polling = null;
              $(".loader").hide();
              console.log("Queue finished.");
            }
        }
    });
}


$('#closeModal').on('click', function () {
    $('#queueModal').addClass('hidden');

    if (polling) clearInterval(polling);
});

</script>
  <script>
     // Lấy giá trị sort từ URL (vd: ?sort=asc hoặc ?sort=desc)
    function getSortFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const s = params.get('sort');
      if (s === 'asc' || s === 'desc') return s;
      return 'desc'; // mặc định
    }
    // --- Hàm check ---
    async function check(url) {
      const formData = new FormData();
      formData.append('channel_url', url);

      try {
        const resp = await fetch('check.php', {
          method: 'POST',
          body: formData
        });

        const data = await resp.json();

        if (data.error) {
          $('#result').html(`<p class="text-red-500">${data.error}</p>`);
        } else {
          $('#result').html(`
            <p><b>URL:</b> <a class="text-blue-600 underline" target="_blank" href="${data.channel_url}">${data.channel_url}</a></p>
            <p><b>Followers:</b> ${data.followers}</p>
            <p><b>Total Views:</b> ${data.total_views}</p>
            <p><b>Số video:</b> ${data.video_count}</p>
            <p><b>Tên kênh:</b> ${data.name_channel}</p>
            <p class="text-green-600 font-semibold">Lưu vào lịch sử thành công!</p>
          `);
        }
        loadHistory(currentPage, $('#search_keyword').val());
      } catch (err) {
        $('#result').html(`<p class="text-red-500">Lỗi server hoặc JSON không hợp lệ</p>`);
      }
    }

    let currentPage = 1;
    let perPage = 50;

    async function loadHistory(page = 1, keyword = '', sort = 'desc') {
      currentPage = page;
      console.log("sort:", sort)
      $('#history').html('<p class="text-gray-500 text-center py-3">Đang tải...</p>');

      try {
        const resp = await fetch(`history.php?page=${page}&per_page=${perPage}&sort=${sort? sort :'desc'}&search=${encodeURIComponent(keyword)}`);
        const data = await resp.json();

        if (!data.items || !data.items.length) {
          $('#history').html('<p class="text-gray-500 text-center py-3">Không có dữ liệu</p>');
          $('#pagination').html('');
          return;
        }

        let html = `<table class="min-w-full border border-gray-200 divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">#</th>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">URL</th>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Followers</th>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Total Views</th>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Video Count</th>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Tên Kênh</th>
              <th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Thời gian</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">`;

        data.items.forEach((row, idx) => {
          html += `
            <tr>
              <td class="px-4 py-2 text-sm">${row.id}</td>
              <td class="px-4 py-2 text-sm text-blue-600 underline"><a href="${row.channel_url}" target="_blank">${row.channel_url}</a></td>
              <td class="px-4 py-2 text-sm">${row.followers || 0}</td>
              <td class="px-4 py-2 text-sm">${row.total_views || 0}</td>
              <td class="px-4 py-2 text-sm">${row.video_count || 0}</td>
              <td class="px-4 py-2 text-sm">${row.name_channel || ''}</td>
              <td class="px-4 py-2 text-sm">${row.checked_at}</td>
            </tr>`;
        });

        html += '</tbody></table>';
        $('#history').html(html);

        // Phân trang
        let totalPages = Math.ceil(data.total / perPage);
        let pagHtml = '';
        for (let i = 1; i <= totalPages; i++) {
          pagHtml += `<button class="px-3 py-1 rounded ${i === page ? 'bg-blue-500 text-white' : 'bg-gray-200'}" data-page="${i}">${i}</button>`;
        }
        $('#pagination').html(pagHtml);

      } catch (err) {
        console.error(err);
        $('#history').html('<p class="text-red-500 text-center">Lỗi tải dữ liệu</p>');
      }
    }

    // Event
    $('#btn-check').on('click', function () {
      const url = $('#channel_url').val().trim();
      if (!url) return;
      $('#result').html('<p class="text-gray-500">Đang kiểm tra...</p>');
      check(url);
    });

    $('#btn-search').on('click', function () {
      loadHistory(1, $('#search_keyword').val());
    });

    $(document).on('click', '#pagination button', function () {
      const page = parseInt($(this).data('page'));
      loadHistory(page, $('#search_keyword').val());
    });

    // Load page đầu
    $(function () {
      loadHistory(currentPage, $('#search_keyword').val(), 'desc');
    });

    // Khi người dùng bấm link sort (hai nút ở trên), không reload mà gọi loadHistory
    $(document).on('click', 'a[data-sort]', function (e) {
      e.preventDefault();
      const sort = $(this).data('sort'); // 'asc' hoặc 'desc'
      // cập nhật url (không reload)
      const newUrl = window.location.pathname + '?sort=' + encodeURIComponent(sort);
      history.pushState({}, '', newUrl);

      // cập nhật UI active (nếu muốn)
      $('a[data-sort]').removeClass('bg-blue-700').addClass('bg-gray-500');
      $(this).removeClass('bg-gray-500').addClass('bg-blue-700');

      loadHistory(currentPage, $('#search_keyword').val(),sort);
    });

    // delegated click cho nút Kiểm tra trong bảng (sinh sau)


    // Khi back/forward browser, tải lại bảng theo param sort hiện tại
    window.addEventListener('popstate', function () {
      const s = getSortFromUrl();
      // update nút active
      $('a[data-sort]').removeClass('bg-blue-700').addClass('bg-gray-500');
      $(`a[data-sort="${s}"]`).removeClass('bg-gray-500').addClass('bg-blue-700');
      loadHistory(currentPage, $('#search_keyword').val(),s);
    });

    // Khi load page lần đầu: bật nút active và load history theo param
    $(function () {
      const initialSort = getSortFromUrl();
      // set active button style (bạn có thể đổi class tuỳ tailwind)
      $('a[data-sort]').removeClass('bg-blue-700').addClass('bg-gray-500');
      $(`a[data-sort="${initialSort}"]`).removeClass('bg-gray-500').addClass('bg-blue-700');

      loadHistory(currentPage, $('#search_keyword').val(),initialSort);
    });

    $('#btn-check').on('click', function () {
      const url = $('#channel_url').val().trim();
      if (!url) return;

      $('#result').html('<p class="text-gray-500">Đang kiểm tra...</p>');
      check(url);
    });
  </script>
</body>
</html>
